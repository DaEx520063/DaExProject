{% if standalone %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>อนุมัติรหัสพนักงาน - HR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .excel-interface { background: white; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .excel-toolbar { background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .excel-table-header { background: #e9ecef; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 12px; color: #495057; }
        .excel-table-body td { padding: 8px; border-right: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6; font-size: 12px; }
        .excel-table-body tr:nth-child(even) { background-color: #f8f9fa; }
        .excel-table-body tr:hover { background-color: #e3f2fd; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
{% endif %}

<div class="excel-interface">
    <!-- Excel Toolbar -->
    <div class="excel-toolbar">
        <div class="d-flex">
            <h4><i class="fas fa-user-check"></i> อนุมัติรหัสพนักงาน</h4>
        </div>
        <div class="d-flex">
            <button class="btn btn-success btn-sm me-2" onclick="bulkApprove()">
                <i class="fas fa-check-double"></i> อนุมัติทั้งหมด
            </button>
            <button class="btn btn-danger btn-sm" onclick="bulkReject()">
                <i class="fas fa-times"></i> ปฏิเสธทั้งหมด
            </button>
        </div>
    </div>

    <!-- Excel Table -->
    <div class="table-responsive">
        <table class="table table-bordered mb-0" id="requestsTable">
            <thead class="excel-table-header">
                <tr>
                    <th>ลำดับ</th>
                    <th>วันที่ขอ</th>
                    <th>รหัสพนักงาน</th>
                    <th>ชื่อ-นามสกุล</th>
                    <th>ตำแหน่ง</th>
                    <th>สาขา</th>
                    <th>โซน</th>
                    <th>ประเภทการจ้าง</th>
                    <th>เรทการจ้าง</th>
                    <th>เบอร์โทร</th>
                    <th>อีเมล</th>
                    <th>เหตุผล</th>
                    <th>ผู้ขอ</th>
                    <th>สถานะ</th>
                    <th>การดำเนินการ</th>
                </tr>
            </thead>
            <tbody class="excel-table-body">
                {% for request in requests %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ request[5] }}</td>
                    <td><strong>{{ request[1] }}</strong></td>
                    <td>{{ request[2] }}</td>
                    <td><span class="badge bg-secondary">{{ request[3] }}</span></td>
                    <td><span class="badge bg-info">{{ branches[request[4]] }}</span></td>
                    <td><span class="badge bg-warning">{{ request[8] or '-' }}</span></td>
                    <td><span class="badge bg-primary">{{ request[9] or '-' }}</span></td>
                    <td><span class="badge bg-success">{{ request[10] or '-' }}</span></td>
                    <td>{{ request[6] or '-' }}</td>
                    <td>{{ request[7] or '-' }}</td>
                    <td>{{ request[11] or '-' }}</td>
                    <td>{{ request[12] or '-' }}</td>
                    <td>
                        {% if request[13] == 'pending' %}
                            <span class="status-badge status-pending">รออนุมัติ</span>
                        {% elif request[13] == 'approved' %}
                            <span class="status-badge status-approved">อนุมัติแล้ว</span>
                        {% elif request[13] == 'rejected' %}
                            <span class="status-badge status-rejected">ปฏิเสธแล้ว</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if request[13] == 'pending' %}
                            <button class="btn btn-sm btn-success me-1" onclick="approveRequest({{ request[0] }})" title="อนุมัติ">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="rejectRequest({{ request[0] }})" title="ปฏิเสธ">
                                <i class="fas fa-times"></i>
                            </button>
                        {% else %}
                            <span class="text-muted">ดำเนินการแล้ว</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ปฏิเสธคำขอ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">เหตุผลในการปฏิเสธ *</label>
                    <textarea id="rejectionReason" class="form-control" rows="3" placeholder="ระบุเหตุผลในการปฏิเสธ..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">ปฏิเสธ</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentRequestId = null;

function approveRequest(requestId) {
    if (confirm('คุณต้องการอนุมัติคำขอนี้ใช่หรือไม่?')) {
        fetch(`/api/employee-requests/${requestId}/approve`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('อนุมัติสำเร็จ');
                location.reload();
            } else {
                alert('เกิดข้อผิดพลาด: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
        });
    }
}

function rejectRequest(requestId) {
    currentRequestId = requestId;
    new bootstrap.Modal(document.getElementById('rejectModal')).show();
}

function confirmReject() {
    const rejectionReason = document.getElementById('rejectionReason').value;
    if (!rejectionReason.trim()) {
        alert('กรุณาระบุเหตุผลในการปฏิเสธ');
        return;
    }
    
    const formData = new FormData();
    formData.append('rejection_reason', rejectionReason);
    
    fetch(`/api/employee-requests/${currentRequestId}/reject`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ปฏิเสธสำเร็จ');
            location.reload();
        } else {
            alert('เกิดข้อผิดพลาด: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
    });
}

function bulkApprove() {
    if (confirm('คุณต้องการอนุมัติคำขอทั้งหมดที่รอการอนุมัติใช่หรือไม่?')) {
        // Implement bulk approve functionality
        alert('ฟังก์ชันนี้จะถูกพัฒนาต่อ');
    }
}

function bulkReject() {
    if (confirm('คุณต้องการปฏิเสธคำขอทั้งหมดที่รอการอนุมัติใช่หรือไม่?')) {
        // Implement bulk reject functionality
        alert('ฟังก์ชันนี้จะถูกพัฒนาต่อ');
    }
}
</script>

{% if standalone %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% endif %} 