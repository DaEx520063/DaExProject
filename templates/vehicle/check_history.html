<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการตรวจเช็คสภาพรถ - JMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status-good { background-color: #d4edda; color: #155724; }
        .status-warning { background-color: #fff3cd; color: #856404; }
        .status-bad { background-color: #f8d7da; color: #721c24; }
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/vehicle/dashboard">
                <i class="fas fa-car"></i> JMS Vehicle Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/vehicle/dashboard">หน้าหลัก</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/vehicle/register">ลงทะเบียนใช้งาน</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/vehicle/check">ตรวจเช็คสภาพ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/vehicle/check-history">ประวัติการตรวจเช็ค</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/vehicle/list">รายการรถ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/vehicle/fuel">ประวัติน้ำมัน</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-history text-primary"></i> ประวัติการตรวจเช็คสภาพรถ</h2>
                <p class="text-muted">ดูประวัติการตรวจเช็คสภาพรถทั้งหมด</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">เลือกรถ</label>
                    <select class="form-select" id="vehicleFilter">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">วันที่เริ่มต้น</label>
                    <input type="date" class="form-control" id="startDateFilter">
                </div>
                <div class="col-md-3">
                    <label class="form-label">วันที่สิ้นสุด</label>
                    <input type="date" class="form-control" id="endDateFilter">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-search"></i> ค้นหา
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> ล้างตัวกรอง
                    </button>
                </div>
            </div>
        </div>

        <!-- History Table -->
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> รายการประวัติการตรวจเช็ค</h5>
                <div>
                    <button class="btn btn-danger btn-sm me-2" onclick="deleteSelected()" id="deleteBtn" style="display: none;">
                        <i class="fas fa-trash"></i> ลบรายการที่เลือก
                    </button>
                    <button class="btn btn-light btn-sm" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> ส่งออกข้อมูล Excel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" title="เลือกทั้งหมด">
                                </th>
                                <th>วันที่ตรวจ</th>
                                <th>รถ</th>
                                <th>ผู้ตรวจ</th>
                                <th>สถานะภาพรวม</th>
                                <th>น้ำมันเครื่อง</th>
                                <th>แบตเตอรี่</th>
                                <th>ยาง</th>
                                <th>น้ำมันเบรค</th>
                                <th>น้ำมันครัช</th>
                                <th>น้ำยาแอร์</th>
                                <th>น้ำหล่อเย็น</th>
                                <th>ประตูรถ</th>
                                <th>ไฟหน้า-ท้าย</th>
                                <th>กระจกมองข้าง</th>
                                <th>อื่นๆ</th>
                                <th>รูปภาพ</th>
                                <th>คำแนะนำ</th>
                                <th>ตรวจครั้งถัดไป</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="19" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">กำลังโหลด...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="noData" class="text-center d-none mt-3">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">ไม่พบข้อมูลการตรวจเช็ค</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">รูปภาพการตรวจเช็ค</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="imageModalContent">
                        <!-- รูปภาพจะถูกแสดงที่นี่ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentHistory = [];

        function getStatusBadge(status) {
            if (!status) return '<span class="text-muted">-</span>';
            const statusMap = {
                'good': { class: 'status-good', text: 'ดี' },
                'warning': { class: 'status-warning', text: 'ควรระวัง' },
                'bad': { class: 'status-bad', text: 'ต้องซ่อม' }
            };
            const statusInfo = statusMap[status] || { class: 'status-badge', text: status };
            return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function loadVehicles() {
            fetch('/api/vehicle/list')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('vehicleFilter');
                    select.innerHTML = '<option value="">ทั้งหมด</option>';
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(vehicle => {
                            const option = document.createElement('option');
                            option.value = vehicle.vehicle_id;
                            option.textContent = `${vehicle.license_plate || ''} ${vehicle.brand || ''} ${vehicle.model || ''}`.trim();
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading vehicles:', error);
                });
        }

        function loadHistory() {
            const vehicleId = document.getElementById('vehicleFilter').value;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;

            const params = new URLSearchParams();
            if (vehicleId) params.append('vehicle_id', vehicleId);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            fetch(`/api/vehicle/check-history?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    currentHistory = Array.isArray(data) ? data : [];
                    displayHistory(currentHistory);
                })
                .catch(error => {
                    console.error('Error loading history:', error);
                    document.getElementById('historyTableBody').innerHTML = 
                        '<tr><td colspan="19" class="text-center text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
                });
        }

        function displayHistory(history) {
            const tbody = document.getElementById('historyTableBody');
            const noData = document.getElementById('noData');

            // Reset checkbox
            document.getElementById('selectAll').checked = false;
            updateDeleteButton();

            if (!history || history.length === 0) {
                tbody.innerHTML = '';
                noData.classList.remove('d-none');
                return;
            }

            noData.classList.add('d-none');
            tbody.innerHTML = history.map((record, index) => {
                // นับจำนวนรูปภาพที่มี - รองรับ field ใหม่และ field เก่า
                const images = [];
                const imageLabels = {
                    // Field ใหม่จากฟอร์มตรวจเช็ค
                    'oil_image': 'น้ำมันเครื่อง',
                    'battery_image': 'แบตเตอรี่',
                    'tires_image': 'ยางรถยนต์',
                    'brake_fluid_image': 'น้ำมันเบรค',
                    'clutch_fluid_image': 'น้ำมันครัช',
                    'ac_fluid_image': 'น้ำยาแอร์',
                    'coolant_image': 'น้ำหล่อเย็น น้ำกลั่น หม้อน้ำ',
                    'doors_image': 'ประตูรถ ด้ามจับ',
                    'lights_image': 'ไฟหน้า-ท้าย',
                    'mirrors_image': 'กระจกมองข้าง',
                    'others_image': 'อื่นๆ',
                    // Field เก่า (รองรับข้อมูลเก่า)
                    'engine_image': 'เครื่องยนต์',
                    'body_image': 'ตัวถัง',
                    'brakes_image': 'เบรก',
                    'interior_image': 'ภายใน',
                    'overall_image': 'ภาพรวม'
                };
                
                Object.keys(imageLabels).forEach(key => {
                    if (record[key]) {
                        const notesKey = key.replace('_image', '_notes');
                        images.push({
                            label: imageLabels[key],
                            data: record[key],
                            notes: record[notesKey] || record[key.replace('_image', '_notes')] || ''
                        });
                    }
                });
                
                const imageIcon = images.length > 0 
                    ? `<button class="btn btn-sm btn-outline-primary" onclick="showImages(${index})" title="ดูรูปภาพ (${images.length} รูป)">
                         <i class="fas fa-images"></i> ${images.length}
                       </button>`
                    : '<span class="text-muted">-</span>';
                
                return `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input record-checkbox" value="${record.id}" onchange="updateDeleteButton()">
                    </td>
                    <td>${formatDate(record.check_date)}</td>
                    <td>${record.vehicle_display || record.license_plate || record.vehicle_id || '-'}</td>
                    <td>${record.inspector_name || '-'}</td>
                    <td>${getStatusBadge(record.overall_status)}</td>
                    <td>${getStatusBadge(record.oil_status)}</td>
                    <td>${getStatusBadge(record.battery_status)}</td>
                    <td>${getStatusBadge(record.tires_status)}</td>
                    <td>${getStatusBadge(record.brake_fluid_status)}</td>
                    <td>${getStatusBadge(record.clutch_fluid_status)}</td>
                    <td>${getStatusBadge(record.ac_fluid_status)}</td>
                    <td>${getStatusBadge(record.coolant_status)}</td>
                    <td>${getStatusBadge(record.doors_status)}</td>
                    <td>${getStatusBadge(record.lights_status)}</td>
                    <td>${getStatusBadge(record.mirrors_status)}</td>
                    <td>${getStatusBadge(record.others_status)}</td>
                    <td>${imageIcon}</td>
                    <td>${record.recommendations || '-'}</td>
                    <td>${formatDate(record.next_check_date)}</td>
                </tr>
            `;
            }).join('');
        }
        
        function showImages(recordIndex) {
            const record = currentHistory[recordIndex];
            if (!record) return;
            
            const images = [];
            const imageLabels = {
                // Field ใหม่จากฟอร์มตรวจเช็ค
                'oil_image': 'น้ำมันเครื่อง',
                'battery_image': 'แบตเตอรี่',
                'tires_image': 'ยางรถยนต์',
                'brake_fluid_image': 'น้ำมันเบรค',
                'clutch_fluid_image': 'น้ำมันครัช',
                'ac_fluid_image': 'น้ำยาแอร์',
                'coolant_image': 'น้ำหล่อเย็น น้ำกลั่น หม้อน้ำ',
                'doors_image': 'ประตูรถ ด้ามจับ',
                'lights_image': 'ไฟหน้า-ท้าย',
                'mirrors_image': 'กระจกมองข้าง',
                'others_image': 'อื่นๆ',
                // Field เก่า (รองรับข้อมูลเก่า)
                'engine_image': 'เครื่องยนต์',
                'body_image': 'ตัวถัง',
                'brakes_image': 'เบรก',
                'interior_image': 'ภายใน',
                'overall_image': 'ภาพรวม'
            };
            
            Object.keys(imageLabels).forEach(key => {
                if (record[key]) {
                    const notesKey = key.replace('_image', '_notes');
                    images.push({
                        label: imageLabels[key],
                        data: record[key],
                        notes: record[notesKey] || record[key.replace('_image', '_notes')] || ''
                    });
                }
            });
            
            if (images.length === 0) {
                alert('ไม่มีรูปภาพในรายการนี้');
                return;
            }
            
            // แสดงรูปภาพใน modal
            const modalContent = document.getElementById('imageModalContent');
            modalContent.innerHTML = `
                <div class="row">
                    ${images.map(img => `
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <strong>${img.label}</strong>
                                    ${img.notes ? `<br><small class="text-muted">${img.notes}</small>` : ''}
                                </div>
                                <div class="card-body text-center">
                                    <img src="data:image/jpeg;base64,${img.data}" class="img-fluid" style="max-height: 400px;" alt="${img.label}">
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        function applyFilters() {
            loadHistory();
        }

        function clearFilters() {
            document.getElementById('vehicleFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            loadHistory();
        }

        function exportToExcel() {
            const vehicleId = document.getElementById('vehicleFilter').value;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;

            const params = new URLSearchParams();
            if (vehicleId) params.append('vehicle_id', vehicleId);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            // ส่งคำขอเพื่อ download Excel file
            const url = `/api/vehicle/export-check-history?${params.toString()}`;
            window.open(url, '_blank');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            const deleteBtn = document.getElementById('deleteBtn');
            if (checkboxes.length > 0) {
                deleteBtn.style.display = 'inline-block';
            } else {
                deleteBtn.style.display = 'none';
            }
            
            // อัพเดท selectAll checkbox
            const allCheckboxes = document.querySelectorAll('.record-checkbox');
            const selectAll = document.getElementById('selectAll');
            if (allCheckboxes.length > 0) {
                selectAll.checked = checkboxes.length === allCheckboxes.length;
            }
        }

        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('กรุณาเลือกรายการที่ต้องการลบ');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const count = selectedIds.length;

            if (!confirm(`คุณต้องการลบ ${count} รายการที่เลือกหรือไม่?\n\nการดำเนินการนี้ไม่สามารถยกเลิกได้!`)) {
                return;
            }

            // ส่งคำขอลบ
            fetch('/api/vehicle/delete-check-history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`ลบรายการสำเร็จ ${data.deleted_count || count} รายการ`);
                    // รีโหลดข้อมูล
                    loadHistory();
                    // ล้างการเลือกทั้งหมด
                    document.getElementById('selectAll').checked = false;
                    updateDeleteButton();
                } else {
                    alert('เกิดข้อผิดพลาด: ' + (data.message || 'ไม่สามารถลบข้อมูลได้'));
                }
            })
            .catch(error => {
                console.error('Error deleting records:', error);
                alert('เกิดข้อผิดพลาดในการลบข้อมูล');
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadVehicles();
            loadHistory();
        });
    </script>
</body>
</html>

