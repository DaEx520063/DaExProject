<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สรุปเงินได้พนักงาน - DaEx System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-truck"></i> DaEx System
            </a>
            <span class="navbar-text text-white">
                สรุปเงินได้พนักงาน
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-chart-line"></i> สรุปเงินได้พนักงาน
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    หน้าสรุปเงินได้พนักงานตามช่วงเวลาและสาขา
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Section -->
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label for="monthFilter" class="form-label">เดือน</label>
                                <select id="monthFilter" class="form-select">
                                    <option value="">ทั้งหมด</option>
                                    <option value="1">มกราคม</option>
                                    <option value="2">กุมภาพันธ์</option>
                                    <option value="3">มีนาคม</option>
                                    <option value="4">เมษายน</option>
                                    <option value="5">พฤษภาคม</option>
                                    <option value="6">มิถุนายน</option>
                                    <option value="7" selected>กรกฎาคม</option>
                                    <option value="8">สิงหาคม</option>
                                    <option value="9">กันยายน</option>
                                    <option value="10">ตุลาคม</option>
                                    <option value="11">พฤศจิกายน</option>
                                    <option value="12">ธันวาคม</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="yearFilter" class="form-label">ปี</label>
                                <select id="yearFilter" class="form-select">
                                    <option value="2025" selected>2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="branchFilter" class="form-label">สาขา</label>
                                <select id="branchFilter" class="form-select">
                                    <option value="">ทั้งหมด</option>
                                    {% for code, name in branches.items() %}
                                        <option value="{{ code }}">{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="positionFilter" class="form-label">ตำแหน่ง</label>
                                <select id="positionFilter" class="form-select">
                                    <option value="">ทั้งหมด</option>
                                    <option value="SPT">SPT</option>
                                    <option value="SPTB">SPTB</option>
                                    <option value="SPTC">SPTC</option>
                                    <option value="ADM">ADM</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" onclick="loadIncomeSummary()">
                                        <i class="fas fa-search"></i> ค้นหา
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-success" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel"></i> ส่งออก
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">จำนวนพนักงาน</h5>
                                        <h3 id="totalEmployees">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">เงินเดือนรวม</h5>
                                        <h3 id="totalSalary">0 บาท</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">พัสดุรวม</h5>
                                        <h3 id="totalBonus">0 ชิ้น</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">มีเรทแล้ว</h5>
                                        <h3 id="totalPenalty">0 รายการ</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Table -->
                        <div class="row">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="incomeTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>#</th>
                                                <th>รหัสพนักงาน</th>
                                                <th>ชื่อ-นามสกุล</th>
                                                <th>ตำแหน่ง</th>
                                                <th>สาขา</th>
                                                <th>ประเภทการจ้าง</th>
                                                <th>โซน</th>
                                                <th>เงินเดือนฐาน</th>
                                                <th>โบนัสเรทชิ้น</th>
                                                <th>เบี้ยเลี้ยง</th>
                                                <th>จำนวนพัสดุ</th>
                                                <th>เงินเดือนรวม</th>
                                                <th>0.00-0.50KG<br><small>(เรท)</small></th>
                                                <th>0.51-1.00KG<br><small>(เรท)</small></th>
                                                <th>1.01-1.50KG<br><small>(เรท)</small></th>
                                                <th>1.51-2.00KG<br><small>(เรท)</small></th>
                                                <th>2.01-2.50KG<br><small>(เรท)</small></th>
                                                <th>2.51-3.00KG<br><small>(เรท)</small></th>
                                                <th>3.01-5.00KG<br><small>(เรท)</small></th>
                                                <th>5.01-10.00KG<br><small>(เรท)</small></th>
                                                <th>10.01-15.00KG<br><small>(เรท)</small></th>
                                                <th>15.00+KG<br><small>(เรท)</small></th>
                                                <th>สถานะเรท</th>
                                                <th>การดำเนินการ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="24" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let incomeData = [];

        function loadIncomeSummary() {
            const month = document.getElementById('monthFilter').value;
            const year = document.getElementById('yearFilter').value;
            const branch = document.getElementById('branchFilter').value;
            const position = document.getElementById('positionFilter').value;
            
            console.log('loadIncomeSummary called with:', { month, year, branch, position });
            
            if (!month || !year) {
                alert('กรุณาเลือกเดือนและปี');
                return;
            }
            
            // แสดง loading
            const tbody = document.querySelector('#incomeTable tbody');
            tbody.innerHTML = '<tr><td colspan="24" class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</td></tr>';
            
            // สร้าง URL พร้อม parameters
            let url = `/api/salary/monthly-data?month=${month}&year=${year}`;
            if (branch) url += `&branch=${branch}`;
            if (position) url += `&position=${position}`;
            
            console.log('Fetching URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    incomeData = data.employees || [];
                    console.log('Income data length:', incomeData.length);
                    updateSummaryCards();
                    updateIncomeTable();
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    const tbody = document.querySelector('#incomeTable tbody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="24" class="text-center text-danger">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
                    }
                });
        }

        function updateSummaryCards() {
            const totalEmployees = incomeData.length;
            const totalSalary = incomeData.reduce((sum, emp) => sum + (emp.calculated_salary || 0), 0);
            const totalPackages = incomeData.reduce((sum, emp) => sum + (emp.packages || 0), 0);
            const assignedRates = incomeData.filter(emp => emp.rate_status === 'assigned').length;
            
            document.getElementById('totalEmployees').textContent = totalEmployees.toLocaleString();
            document.getElementById('totalSalary').textContent = totalSalary.toLocaleString() + ' บาท';
            document.getElementById('totalBonus').textContent = totalPackages.toLocaleString() + ' ชิ้น';
            document.getElementById('totalPenalty').textContent = assignedRates.toLocaleString() + ' รายการ';
        }

        function updateIncomeTable() {
            const tbody = document.querySelector('#incomeTable tbody');
            tbody.innerHTML = '';
            
            if (incomeData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="24" class="text-center text-muted">ไม่มีข้อมูล</td></tr>';
                return;
            }
            
            incomeData.forEach((emp, index) => {
                const row = document.createElement('tr');
                
                // สร้าง badge สำหรับประเภทการจ้าง
                const employmentTypeBadge = emp.employment_type === 'piece_rate' 
                    ? '<span class="badge bg-info">เรทชิ้น</span>'
                    : emp.employment_type === 'base_salary'
                    ? '<span class="badge bg-warning">เรทฐานเงินเดือน</span>'
                    : `<span class="badge bg-secondary">${emp.employment_type || '-'}</span>`;
                
                // สร้าง badge สำหรับสถานะเรท
                const rateStatusBadge = emp.rate_status === 'assigned'
                    ? '<span class="badge bg-success">มีเรทแล้ว</span>'
                    : '<span class="badge bg-warning">ยังไม่มีเรท</span>';
                
                // สร้างข้อมูลช่วงน้ำหนัก
                const weightRangesData = emp.weight_ranges || [];
                const weightRangeCells = [];
                
                for (let i = 0; i < 10; i++) {
                    const range = weightRangesData[i] || { rate: 0 };
                    weightRangeCells.push(
                        `<td class="text-center">
                            <div class="text-primary fw-bold">฿${(range.rate || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </td>`
                    );
                }
                
                // สร้างปุ่มการดำเนินการ
                const actionButtons = `
                    <button class="btn btn-sm btn-info" onclick="viewEmployeeDetail('${emp.employee_id}')">
                        <i class="fas fa-eye"></i> ดู
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="editEmployeeRate('${emp.employee_id}')">
                        <i class="fas fa-edit"></i> แก้ไข
                    </button>
                `;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${emp.employee_id || ''}</td>
                    <td>${emp.name || ''}</td>
                    <td>${emp.position || ''}</td>
                    <td>${emp.branch_code || ''}</td>
                    <td>${employmentTypeBadge}</td>
                    <td>${emp.zone || '-'}</td>
                    <td class="text-end">฿${(emp.upload_base_salary || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="text-end">฿${(emp.upload_piece_rate_bonus || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="text-end">฿${(emp.upload_allowance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="text-end">${(emp.packages || 0).toLocaleString()}</td>
                    <td class="text-end fw-bold">฿${(emp.calculated_salary || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    ${weightRangeCells.join('')}
                    <td>${rateStatusBadge}</td>
                    <td>${actionButtons}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportToExcel() {
            alert('ส่งออกไฟล์ Excel เรียบร้อยแล้ว');
        }

        function viewEmployeeDetail(employeeId) {
            alert('ดูรายละเอียดพนักงาน: ' + employeeId);
        }

        function editEmployeeRate(employeeId) {
            alert('แก้ไขข้อมูลเรทของพนักงาน: ' + employeeId);
        }

        // โหลดข้อมูลเมื่อหน้าโหลด
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Income summary standalone page loaded');
            
            // โหลดข้อมูลอัตโนมัติ
            setTimeout(() => {
                console.log('Auto-loading data for July 2025');
                loadIncomeSummary();
            }, 1000);
        });
    </script>
</body>
</html>