<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>
                        ประวัติการอัปโหลด
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="monthFilter" class="form-label">เดือน</label>
                            <select class="form-select" id="monthFilter">
                                <option value="">เลือกเดือน</option>
                                <option value="1">มกราคม</option>
                                <option value="2">กุมภาพันธ์</option>
                                <option value="3">มีนาคม</option>
                                <option value="4">เมษายน</option>
                                <option value="5">พฤษภาคม</option>
                                <option value="6">มิถุนายน</option>
                                <option value="7">กรกฎาคม</option>
                                <option value="8">สิงหาคม</option>
                                <option value="9">กันยายน</option>
                                <option value="10">ตุลาคม</option>
                                <option value="11">พฤศจิกายน</option>
                                <option value="12">ธันวาคม</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="yearFilter" class="form-label">ปี</label>
                            <select class="form-select" id="yearFilter">
                                <option value="">เลือกปี</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="branchFilter" class="form-label">สาขา</label>
                            <select class="form-select" id="branchFilter">
                                <option value="">ทุกสาขา</option>
                                {% for code, name in branches.items() %}
                                <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary me-2" onclick="searchUploadHistory()">
                                <i class="fas fa-search me-1"></i>ค้นหา
                            </button>
                            <button class="btn btn-secondary" onclick="resetUploadHistory()">
                                <i class="fas fa-refresh me-1"></i>รีเซ็ต
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>วันที่อัปโหลด</th>
                                    <th>ไฟล์</th>
                                    <th>เดือน/ปี</th>
                                    <th>จำนวนรายการ</th>
                                    <th>สถานะ</th>
                                    <th>ผู้อัปโหลด</th>
                                    <th>การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="uploadHistoryTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        เลือกเดือนและปีเพื่อดูประวัติการอัปโหลด
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function searchUploadHistory() {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    const branch = document.getElementById('branchFilter').value;
    
    if (!month || !year) {
        alert('กรุณาเลือกเดือนและปี');
        return;
    }
    
    // แสดง loading
    document.getElementById('uploadHistoryTable').innerHTML = `
        <tr>
            <td colspan="7" class="text-center">
                <i class="fas fa-spinner fa-spin me-2"></i>
                กำลังโหลดข้อมูล...
            </td>
        </tr>
    `;
    
    // เรียก API
    fetch(`/api/upload-history/${month}/${year}?branch=${branch}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('uploadHistoryTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.error}
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (data.uploads && data.uploads.length > 0) {
                const html = data.uploads.map(upload => `
                    <tr>
                        <td>${upload.upload_date}</td>
                        <td>${upload.filename}</td>
                        <td>${upload.work_month}</td>
                        <td>${upload.total_records}</td>
                        <td>
                            <span class="badge bg-${upload.status === 'completed' ? 'success' : 'warning'}">
                                ${upload.status === 'completed' ? 'เสร็จสิ้น' : 'กำลังประมวลผล'}
                            </span>
                        </td>
                        <td>${upload.uploaded_by}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUpload(${upload.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('uploadHistoryTable').innerHTML = html;
            } else {
                document.getElementById('uploadHistoryTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            ไม่พบข้อมูลการอัปโหลด
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('uploadHistoryTable').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        เกิดข้อผิดพลาดในการโหลดข้อมูล
                    </td>
                </tr>
            `;
        });
}

function resetUploadHistory() {
    document.getElementById('monthFilter').value = '';
    document.getElementById('yearFilter').value = '2025';
    document.getElementById('branchFilter').value = '';
    document.getElementById('uploadHistoryTable').innerHTML = `
        <tr>
            <td colspan="7" class="text-center text-muted">
                <i class="fas fa-info-circle me-2"></i>
                เลือกเดือนและปีเพื่อดูประวัติการอัปโหลด
            </td>
        </tr>
    `;
}

function deleteUpload(uploadId) {
    if (confirm('คุณต้องการลบข้อมูลการอัปโหลดนี้หรือไม่?')) {
        fetch(`/api/delete-upload/${uploadId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ลบข้อมูลสำเร็จ');
                searchUploadHistory(); // โหลดข้อมูลใหม่
            } else {
                alert('เกิดข้อผิดพลาด: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการลบข้อมูล');
        });
    }
}
</script> 