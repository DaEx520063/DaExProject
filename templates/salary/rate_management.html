<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-cog"></i> การจัดการเรทเงินเดือนพนักงาน
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                หน้าจัดการเรทเงินเดือนสำหรับพนักงานประเภทต่างๆ
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="positionFilter" class="form-label">ตำแหน่ง</label>
                            <select id="positionFilter" class="form-select">
                                <option value="">ทั้งหมด</option>
                                <option value="SPT">SPT - พนักงานขนส่ง</option>
                                <option value="SPTB">SPTB - พนักงานขนส่ง B</option>
                                <option value="SPTC">SPTC - พนักงานขนส่ง C</option>
                                <option value="ADM">ADM - ผู้ดูแลระบบสาขา</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="zoneFilter" class="form-label">โซน</label>
                            <select id="zoneFilter" class="form-select">
                                <option value="">ทั้งหมด</option>
                                <option value="office">Office</option>
                                <option value="field">Field</option>
                                <option value="warehouse">Warehouse</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="branchFilter" class="form-label">สาขา</label>
                            <select id="branchFilter" class="form-select">
                                <option value="">ทั้งหมด</option>
                                {% for code, name in branches.items() %}
                                    <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button class="btn btn-primary" onclick="loadRates()">
                                    <i class="fas fa-search"></i> ค้นหา
                                </button>
                                <button class="btn btn-success" onclick="addNewRate()">
                                    <i class="fas fa-plus"></i> เพิ่มเรทใหม่
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Rates Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="ratesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ลำดับ</th>
                                    <th>ตำแหน่ง</th>
                                    <th>โซน</th>
                                    <th>สาขา</th>
                                    <th>ฐานเงินเดือน</th>
                                    <th>เรทชิ้น</th>
                                    <th>ค่าอินเซนทิฟ</th>
                                    <th>ค่าอุปกรณ์</th>
                                    <th>การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if piece_rates %}
                                    {% for rate in piece_rates %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ rate[3] }}</td>
                                        <td>{{ rate[1] }}</td>
                                        <td>สาขา {{ rate[2] }}</td>
                                        <td>{{ "{:,.0f}".format(rate[5] or 0) }} บาท</td>
                                        <td>{{ "{:.2f}".format(rate[6] or 0) }} บาท/ชิ้น</td>
                                        <td>{{ "{:,.0f}".format(rate[7] or 0) }} บาท</td>
                                        <td>{{ "{:,.0f}".format(rate[8] or 0) }} บาท</td>
                                        <td>
                                            <button class="btn btn-sm btn-warning" onclick="editRate({{ rate[0] }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteRate({{ rate[0] }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Rate Modal -->
<div class="modal fade" id="rateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rateModalTitle">เพิ่มเรทใหม่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rateForm">
                    <input type="hidden" id="rateId" name="rate_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="position" class="form-label">ตำแหน่ง *</label>
                                <select id="position" name="position" class="form-select" required>
                                    <option value="">เลือกตำแหน่ง</option>
                                    <option value="SPT">SPT - พนักงานขนส่ง</option>
                                    <option value="SPTB">SPTB - พนักงานขนส่ง B</option>
                                    <option value="SPTC">SPTC - พนักงานขนส่ง C</option>
                                    <option value="ADM">ADM - ผู้ดูแลระบบสาขา</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="zone" class="form-label">โซน *</label>
                                <select id="zone" name="zone" class="form-select" required>
                                    <option value="">เลือกโซน</option>
                                    <option value="office">Office</option>
                                    <option value="field">Field</option>
                                    <option value="warehouse">Warehouse</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="branch" class="form-label">สาขา *</label>
                                <select id="branch" name="branch" class="form-select" required>
                                    <option value="">เลือกสาขา</option>
                                    {% for code, name in branches.items() %}
                                        <option value="{{ code }}">{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="salaryType" class="form-label">ประเภทเงินเดือน *</label>
                                <select id="salaryType" name="salary_type" class="form-select" required>
                                    <option value="">เลือกประเภท</option>
                                    <option value="base_salary">ฐานเงินเดือน</option>
                                    <option value="piece_rate">เรทชิ้น</option>
                                    <option value="incentive">ค่าอินเซนทิฟ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="baseSalary" class="form-label">ฐานเงินเดือน (บาท)</label>
                                <input type="number" id="baseSalary" name="base_salary" class="form-control" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="pieceRate" class="form-label">เรทชิ้น (บาท/ชิ้น)</label>
                                <input type="number" id="pieceRate" name="piece_rate" class="form-control" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="incentive" class="form-label">ค่าอินเซนทิฟ (บาท)</label>
                                <input type="number" id="incentive" name="incentive" class="form-control" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="equipment" class="form-label">ค่าอุปกรณ์ (บาท)</label>
                                <input type="number" id="equipment" name="equipment" class="form-control" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="target" class="form-label">เป้าหมาย (ชิ้น/เดือน)</label>
                                <input type="number" id="target" name="target" class="form-control" min="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" onclick="saveRate()">บันทึก</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // ใช้ข้อมูลเรทจากฐานข้อมูลที่ส่งมาจาก backend
    const pieceRatesData = {{ piece_rates|tojson|safe if piece_rates else '[]' }};

    // ทำให้ฟังก์ชันสามารถเรียกใช้จากภายนอกได้
    window.loadRates = function() {
        const position = document.getElementById('positionFilter').value;
        const zone = document.getElementById('zoneFilter').value;
        const branch = document.getElementById('branchFilter').value;
        
        // กรองข้อมูลตาม filter
        let filteredRates = pieceRatesData;
        
        if (position) {
            filteredRates = filteredRates.filter(rate => rate[3] === position);
        }
        if (zone) {
            filteredRates = filteredRates.filter(rate => rate[1] === zone);
        }
        if (branch) {
            filteredRates = filteredRates.filter(rate => rate[2] === branch);
        }
        
        updateRatesTable(filteredRates);
    };

    function updateRatesTable(data = pieceRatesData) {
        const tbody = document.querySelector('#ratesTable tbody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ไม่มีข้อมูลเรท</td></tr>';
            return;
        }
        
        data.forEach((rate, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${rate[3]}</td>
                <td>${rate[1]}</td>
                <td>สาขา ${rate[2]}</td>
                <td>${(rate[5] || 0).toLocaleString()} บาท</td>
                <td>${(rate[6] || 0).toFixed(2)} บาท/ชิ้น</td>
                <td>${(rate[7] || 0).toLocaleString()} บาท</td>
                <td>${(rate[8] || 0).toLocaleString()} บาท</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editRate(${rate[0]})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteRate(${rate[0]})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    window.addNewRate = function() {
        document.getElementById('rateModalTitle').textContent = 'เพิ่มเรทใหม่';
        document.getElementById('rateForm').reset();
        document.getElementById('rateId').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('rateModal'));
        modal.show();
    };

    window.editRate = function(rateId) {
        const rate = pieceRatesData.find(r => r[0] === rateId);
        if (!rate) return;
        
        document.getElementById('rateModalTitle').textContent = 'แก้ไขเรท';
        document.getElementById('rateId').value = rate[0];
        document.getElementById('position').value = rate[3];
        document.getElementById('zone').value = rate[1];
        document.getElementById('branch').value = rate[2];
        document.getElementById('baseSalary').value = rate[5] || 0;
        document.getElementById('pieceRate').value = rate[6] || 0;
        document.getElementById('incentive').value = rate[7] || 0;
        document.getElementById('equipment').value = rate[8] || 0;
        
        const modal = new bootstrap.Modal(document.getElementById('rateModal'));
        modal.show();
    };

    window.saveRate = function() {
        const formData = new FormData(document.getElementById('rateForm'));
        const rateId = formData.get('rate_id');
        
        // จำลองการบันทึก
        alert(rateId ? 'แก้ไขเรทเรียบร้อยแล้ว' : 'เพิ่มเรทใหม่เรียบร้อยแล้ว');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('rateModal'));
        modal.hide();
        
        loadRates();
    };

    window.deleteRate = function(rateId) {
        if (confirm('คุณต้องการลบเรทนี้ใช่หรือไม่?')) {
            // จำลองการลบ
            const updatedRates = pieceRatesData.filter(r => r[0] !== rateId);
            updateRatesTable(updatedRates);
            alert('ลบเรทเรียบร้อยแล้ว');
        }
    };

    // โหลดข้อมูลเมื่อหน้าโหลด
    document.addEventListener('DOMContentLoaded', function() {
        updateRatesTable();
    });
})();
</script> 