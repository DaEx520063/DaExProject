<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-alt me-2"></i>
                        สรุปการอัปโหลด
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="monthFilter" class="form-label">เดือน</label>
                            <select class="form-select" id="monthFilter">
                                <option value="">เลือกเดือน</option>
                                <option value="1">มกราคม</option>
                                <option value="2">กุมภาพันธ์</option>
                                <option value="3">มีนาคม</option>
                                <option value="4">เมษายน</option>
                                <option value="5">พฤษภาคม</option>
                                <option value="6">มิถุนายน</option>
                                <option value="7">กรกฎาคม</option>
                                <option value="8">สิงหาคม</option>
                                <option value="9">กันยายน</option>
                                <option value="10">ตุลาคม</option>
                                <option value="11">พฤศจิกายน</option>
                                <option value="12">ธันวาคม</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="yearFilter" class="form-label">ปี</label>
                            <select class="form-select" id="yearFilter">
                                <option value="">เลือกปี</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="branchFilter" class="form-label">สาขา</label>
                            <select class="form-select" id="branchFilter">
                                <option value="">ทุกสาขา</option>
                                {% for code, name in branches.items() %}
                                <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary me-2" onclick="searchUploadSummary()">
                                <i class="fas fa-search me-1"></i>ค้นหา
                            </button>
                            <button class="btn btn-secondary" onclick="resetUploadSummary()">
                                <i class="fas fa-refresh me-1"></i>รีเซ็ต
                            </button>
                        </div>
                    </div>

                    <!-- สถิติสรุป -->
                    <div class="row mb-4" id="summaryStats">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 id="totalUploads">0</h4>
                                    <p class="mb-0">จำนวนการอัปโหลด</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="totalRecords">0</h4>
                                    <p class="mb-0">จำนวนรายการ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 id="totalAmount">0</h4>
                                    <p class="mb-0">จำนวนเงินรวม</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 id="avgAmount">0</h4>
                                    <p class="mb-0">เฉลี่ยต่อรายการ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ตารางสรุป -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>เดือน/ปี</th>
                                    <th>จำนวนการอัปโหลด</th>
                                    <th>จำนวนรายการ</th>
                                    <th>จำนวนเงินรวม</th>
                                    <th>เฉลี่ยต่อรายการ</th>
                                    <th>สถานะ</th>
                                    <th>รายละเอียด</th>
                                </tr>
                            </thead>
                            <tbody id="uploadSummaryTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        เลือกเดือนและปีเพื่อดูสรุปการอัปโหลด
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function searchUploadSummary() {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    const branch = document.getElementById('branchFilter').value;
    
    if (!month || !year) {
        alert('กรุณาเลือกเดือนและปี');
        return;
    }
    
    // แสดง loading
    document.getElementById('uploadSummaryTable').innerHTML = `
        <tr>
            <td colspan="7" class="text-center">
                <i class="fas fa-spinner fa-spin me-2"></i>
                กำลังโหลดข้อมูล...
            </td>
        </tr>
    `;
    
    // เรียก API
    fetch(`/api/upload-results/${month}/${year}?branch=${branch}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('uploadSummaryTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.error}
                        </td>
                    </tr>
                `;
                return;
            }
            
            // อัปเดตสถิติ
            if (data.summary) {
                document.getElementById('totalUploads').textContent = data.summary.total_uploads || 0;
                document.getElementById('totalRecords').textContent = data.summary.total_records || 0;
                document.getElementById('totalAmount').textContent = (data.summary.total_amount || 0).toLocaleString();
                document.getElementById('avgAmount').textContent = (data.summary.avg_amount || 0).toLocaleString();
            }
            
            if (data.results && data.results.length > 0) {
                const html = data.results.map(result => `
                    <tr>
                        <td>${result.work_month}</td>
                        <td>${result.upload_count}</td>
                        <td>${result.total_records}</td>
                        <td>${(result.total_amount || 0).toLocaleString()}</td>
                        <td>${(result.avg_amount || 0).toLocaleString()}</td>
                        <td>
                            <span class="badge bg-${result.status === 'completed' ? 'success' : 'warning'}">
                                ${result.status === 'completed' ? 'เสร็จสิ้น' : 'กำลังประมวลผล'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${result.work_month}')">
                                <i class="fas fa-eye"></i> ดูรายละเอียด
                            </button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('uploadSummaryTable').innerHTML = html;
            } else {
                document.getElementById('uploadSummaryTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            ไม่พบข้อมูลสรุปการอัปโหลด
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('uploadSummaryTable').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        เกิดข้อผิดพลาดในการโหลดข้อมูล
                    </td>
                </tr>
            `;
        });
}

function resetUploadSummary() {
    document.getElementById('monthFilter').value = '';
    document.getElementById('yearFilter').value = '2025';
    document.getElementById('branchFilter').value = '';
    document.getElementById('totalUploads').textContent = '0';
    document.getElementById('totalRecords').textContent = '0';
    document.getElementById('totalAmount').textContent = '0';
    document.getElementById('avgAmount').textContent = '0';
    document.getElementById('uploadSummaryTable').innerHTML = `
        <tr>
            <td colspan="7" class="text-center text-muted">
                <i class="fas fa-info-circle me-2"></i>
                เลือกเดือนและปีเพื่อดูสรุปการอัปโหลด
            </td>
        </tr>
    `;
}

function viewDetails(workMonth) {
    // เปิด modal หรือเปลี่ยนหน้าเพื่อดูรายละเอียด
    alert(`ดูรายละเอียดสำหรับ ${workMonth}`);
}
</script> 