{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>ข้อมูลการมาทำงาน - {{ branch_name }}
                    </h5>
                    <div>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAttendanceModal">
                            <i class="fas fa-plus me-1"></i>เพิ่มข้อมูล
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>พนักงาน</th>
                                    <th>วันที่</th>
                                    <th>เวลาเข้า</th>
                                    <th>เวลาออก</th>
                                    <th>ชั่วโมงทำงาน</th>
                                    <th>โอที</th>
                                    <th>สถานะ</th>
                                    <th>หมายเหตุ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in attendance_records %}
                                <tr>
                                    <td>
                                        <strong>{{ record[1] }}</strong><br>
                                        <small class="text-muted">{{ record[2] }}</small>
                                    </td>
                                    <td>{{ record[3] }}</td>
                                    <td>{{ record[4] or '-' }}</td>
                                    <td>{{ record[5] or '-' }}</td>
                                    <td>{{ "%.1f"|format(record[6] or 0) }}</td>
                                    <td>{{ "%.1f"|format(record[7] or 0) }}</td>
                                    <td>
                                        {% if record[8] == 'present' %}
                                            <span class="badge bg-success">มาทำงาน</span>
                                        {% elif record[8] == 'absent' %}
                                            <span class="badge bg-danger">ขาด</span>
                                        {% elif record[8] == 'late' %}
                                            <span class="badge bg-warning">มาสาย</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ record[8] }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ record[9] or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- สรุปสถิติสาขา -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">พนักงานในสาขา</h6>
                            <h3 class="mb-0">
                                {% set unique_employees = [] %}
                                {% for record in attendance_records %}
                                    {% if record[2] not in unique_employees %}
                                        {% set unique_employees = unique_employees + [record[2]] %}
                                    {% endif %}
                                {% endfor %}
                                {{ unique_employees|length }}
                            </h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">มาทำงาน</h6>
                            <h3 class="mb-0">
                                {% set present_count = 0 %}
                                {% for record in attendance_records %}
                                    {% if record[8] == 'present' %}
                                        {% set present_count = present_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ present_count }}
                            </h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">มาสาย</h6>
                            <h3 class="mb-0">
                                {% set late_count = 0 %}
                                {% for record in attendance_records %}
                                    {% if record[8] == 'late' %}
                                        {% set late_count = late_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ late_count }}
                            </h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">ขาด</h6>
                            <h3 class="mb-0">
                                {% set absent_count = 0 %}
                                {% for record in attendance_records %}
                                    {% if record[8] == 'absent' %}
                                        {% set absent_count = absent_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ absent_count }}
                            </h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-times-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal เพิ่มข้อมูลการทำงาน -->
<div class="modal fade" id="addAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">เพิ่มข้อมูลการทำงาน</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="attendanceForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">รหัสพนักงาน</label>
                                <input type="text" class="form-control" id="employee_id" name="employee_id" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">วันที่</label>
                                <input type="date" class="form-control" id="work_date" name="work_date" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">เวลาเข้า</label>
                                <input type="time" class="form-control" id="check_in" name="check_in">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">เวลาออก</label>
                                <input type="time" class="form-control" id="check_out" name="check_out">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">สถานะ</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="present">มาทำงาน</option>
                                    <option value="absent">ขาด</option>
                                    <option value="late">มาสาย</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">หมายเหตุ</label>
                                <input type="text" class="form-control" id="notes" name="notes">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" onclick="saveAttendance()">บันทึก</button>
            </div>
        </div>
    </div>
</div>

<script>
function saveAttendance() {
    const formData = {
        employee_id: document.getElementById('employee_id').value,
        work_date: document.getElementById('work_date').value,
        check_in: document.getElementById('check_in').value,
        check_out: document.getElementById('check_out').value,
        status: document.getElementById('status').value,
        notes: document.getElementById('notes').value
    };

    fetch('/api/attendance/record', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            $('#addAttendanceModal').modal('hide');
            location.reload();
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
    });
}

// Set default date to today
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('work_date').value = today;
});
</script>
{% endblock %} 